#!/usr/bin/env bash
set -eu

echo "ğŸ”µ build"
source hooks/.config

echo "âœ… Will build the following architectures: $(IFS=, ; echo "${build_architectures[@]}")"
echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"

SONARR_RELEASE=$(curl -sL "https://services.sonarr.tv/v1/download/phantom-develop?version=3&os=linux" | jq -r '.version')
sonarr_url='https://services.sonarr.tv/v1/download/phantom-develop/latest?version=3&os=linux'

for arch in ${build_architectures[@]}; do
  echo "âœ… building $arch"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"

  docker exec docker_daemon docker build \
    --squash \
    --platform=${docker_arch_map[${arch}]} \
    --build-arg BASE_IMAGE_PREFIX=${base_image_prefix_map[${arch}]} \
    --build-arg SONARR_RELEASE=${SONARR_RELEASE} \
    --build-arg sonarr_url=${sonarr_url} \
    --file /build/${IMAGE_NAME_simple}/${DOCKERFILE_PATH} \
    --tag "${IMAGE_NAME}-${arch}"  \
    /build/${IMAGE_NAME_simple}
done

echo "âœ… images built:"
echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
docker exec docker_daemon docker image ls

trap "exit 1"          HUP INT PIPE QUIT TERM